---
phase: 03-opennebula-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - appliances/slm-copilot/appliance.sh
autonomous: true

must_haves:
  truths:
    - "All appliance operations (install, configure, bootstrap) write timestamped entries to /var/log/one-appliance/slm-copilot.log"
    - "Running service_configure twice produces identical generated files (excluding timestamp comments)"
    - "Zero bare msg calls remain in appliance.sh outside of the log_copilot wrapper function"
  artifacts:
    - path: "appliances/slm-copilot/appliance.sh"
      provides: "log_copilot helper, init_copilot_log, COPILOT_LOG constant, logging integrated into all lifecycle functions"
      contains: "log_copilot"
  key_links:
    - from: "log_copilot()"
      to: "msg()"
      via: "wraps msg and appends to COPILOT_LOG"
      pattern: "msg.*\\$\\{_level\\}"
    - from: "service_install()"
      to: "log_copilot()"
      via: "replaces all msg calls with log_copilot"
      pattern: "log_copilot info"
    - from: "service_configure()"
      to: "log_copilot()"
      via: "replaces all msg calls with log_copilot"
      pattern: "log_copilot info"
    - from: "service_bootstrap()"
      to: "log_copilot()"
      via: "replaces all msg calls with log_copilot"
      pattern: "log_copilot info"
---

<objective>
Add dedicated application logging to /var/log/one-appliance/slm-copilot.log and replace all msg calls with log_copilot wrapper across all lifecycle functions.

Purpose: Requirement ONE-07 mandates a dedicated log file with timestamps for all appliance operations. The one-apps framework captures stdout/stderr to per-stage logs automatically, but we need a single unified log file that aggregates all stages. This plan also verifies the existing idempotent configure flow (ONE-03) and context variable framework (ONE-01) are complete.

Output: Updated appliance.sh with log_copilot helper, init_copilot_log, COPILOT_LOG constant, and all msg calls replaced with log_copilot calls.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-opennebula-integration/03-RESEARCH.md
@appliances/slm-copilot/appliance.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add log_copilot helper and COPILOT_LOG constant</name>
  <files>appliances/slm-copilot/appliance.sh</files>
  <action>
Add a new constant after the existing constants block (after line ~62):

```bash
readonly COPILOT_LOG="/var/log/one-appliance/slm-copilot.log"
```

Add two new helper functions BEFORE all existing helpers (before generate_model_yaml). Place them in a new "LOGGING" section:

1. `init_copilot_log()` -- creates the log directory and file with correct permissions:
   ```bash
   init_copilot_log() {
       mkdir -p /var/log/one-appliance
       touch "${COPILOT_LOG}"
       chmod 0640 "${COPILOT_LOG}"
   }
   ```

2. `log_copilot()` -- wraps msg and appends timestamped entry to dedicated log:
   ```bash
   log_copilot() {
       local _level="$1"
       shift
       local _message="$*"
       local _timestamp
       _timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
       echo "${_timestamp} [${_level^^}] ${_message}" >> "${COPILOT_LOG}"
       msg "${_level}" "${_message}"
   }
   ```

This follows the research recommendation (Pattern 5) of a dedicated wrapper that writes to both the framework pipe and the dedicated log file.
  </action>
  <verify>Run `bash -n appliances/slm-copilot/appliance.sh` to verify syntax. Grep for `log_copilot` and `COPILOT_LOG` to confirm both exist.</verify>
  <done>COPILOT_LOG constant defined, init_copilot_log and log_copilot functions present in appliance.sh, script passes bash -n syntax check.</done>
</task>

<task type="auto">
  <name>Task 2: Replace all msg calls with log_copilot and add init_copilot_log to lifecycle entry points</name>
  <files>appliances/slm-copilot/appliance.sh</files>
  <action>
1. Add `init_copilot_log` as the FIRST call inside `service_install()`, `service_configure()`, and `service_bootstrap()`. This ensures the log file exists before any log_copilot calls. In service_install it also creates the directory during Packer build time.

2. Replace EVERY `msg info`, `msg warning`, and `msg error` call across ALL functions with the corresponding `log_copilot info`, `log_copilot warning`, `log_copilot error`. This affects all lifecycle functions AND all helper functions:
   - service_install (roughly 10 msg calls)
   - service_configure (roughly 2 msg calls)
   - service_bootstrap (roughly 2 msg calls)
   - generate_model_yaml (1 msg call)
   - generate_env_file (1 msg call)
   - generate_systemd_unit (1 msg call)
   - wait_for_localai (roughly 3 msg calls)
   - validate_config (roughly 6 msg calls)
   - smoke_test (roughly 8 msg calls)
   - generate_selfsigned_cert (1 msg call)
   - generate_htpasswd (roughly 2 msg calls)
   - generate_nginx_config (roughly 2 msg calls)
   - attempt_letsencrypt (roughly 5 msg calls)

Do NOT change the service_help function (it uses `cat`, not msg).
Do NOT change service_cleanup (it's a no-op).

3. Also add a startup log line at the very beginning of each lifecycle function right after init_copilot_log:
   - service_install: `log_copilot info "=== service_install started ==="`
   - service_configure: `log_copilot info "=== service_configure started ==="`
   - service_bootstrap: `log_copilot info "=== service_bootstrap started ==="`

4. Run `shellcheck appliances/slm-copilot/appliance.sh` and fix any warnings. The existing SC2034 disable covers ONE_SERVICE_* vars. Ensure no new warnings are introduced.

5. Verify the total function count: should now be 17 functions (5 lifecycle + 10 existing helpers + 2 new logging helpers).
  </action>
  <verify>
Run all three checks:
- `bash -n appliances/slm-copilot/appliance.sh` passes (syntax OK)
- `shellcheck appliances/slm-copilot/appliance.sh` shows zero warnings
- `grep -c 'msg ' appliances/slm-copilot/appliance.sh` returns 0 (no bare msg calls remaining outside of log_copilot itself)
- `grep -c 'log_copilot' appliances/slm-copilot/appliance.sh` returns a count greater than 30
  </verify>
  <done>Every msg call in appliance.sh (except inside log_copilot itself) is replaced with log_copilot. Each lifecycle function starts with init_copilot_log. Script passes bash -n and shellcheck with zero warnings. Requirements ONE-07 (dedicated log), ONE-01 (context variable framework verified complete), ONE-03 (idempotent configure verified -- all generates use overwrite), ONE-04 (three-stage lifecycle verified) are satisfied.</done>
</task>

</tasks>

<verification>
Phase 3 Plan 01 verification:
1. `bash -n appliances/slm-copilot/appliance.sh` -- syntax valid
2. `shellcheck appliances/slm-copilot/appliance.sh` -- zero warnings
3. `grep -c '^[[:space:]]*msg ' appliances/slm-copilot/appliance.sh` -- returns 0 (only msg call is inside log_copilot)
4. `grep 'log_copilot' appliances/slm-copilot/appliance.sh | head -5` -- shows timestamped logging wrapper calls
5. `grep 'COPILOT_LOG' appliances/slm-copilot/appliance.sh` -- shows constant and usage
6. `grep 'init_copilot_log' appliances/slm-copilot/appliance.sh` -- shows calls in all 3 lifecycle functions
</verification>

<success_criteria>
- COPILOT_LOG constant and log_copilot/init_copilot_log functions exist
- All msg calls replaced with log_copilot (zero bare msg calls outside the wrapper)
- Each lifecycle function calls init_copilot_log as its first action
- Script passes bash -n and shellcheck with zero warnings
- ONE-07 satisfied: all operations will log to /var/log/one-appliance/slm-copilot.log with timestamps
- ONE-01, ONE-03, ONE-04 verified: existing patterns confirmed complete (no changes needed, context vars + idempotent config + lifecycle already correct from Phases 1-2)
</success_criteria>

<output>
After completion, create `.planning/phases/03-opennebula-integration/03-01-SUMMARY.md`
</output>
