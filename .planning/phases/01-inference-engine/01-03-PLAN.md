---
phase: 01-inference-engine
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - appliances/slm-copilot/appliance.sh
autonomous: true

must_haves:
  truths:
    - "ONEAPP_COPILOT_CONTEXT_SIZE context variable controls context_size in both model YAML and env file"
    - "ONEAPP_COPILOT_THREADS context variable controls threads in both model YAML and env file"
    - "Invalid context variable values (non-numeric, negative) are caught by validation and logged as errors"
    - "service_configure validates context variables before generating config files"
    - "The complete appliance.sh passes bash -n and shellcheck with no errors"
    - "The script has a smoke test helper that can verify chat completions and streaming work"
  artifacts:
    - path: "appliances/slm-copilot/appliance.sh"
      provides: "Production-ready appliance script with validation, all 9 INFER requirements addressed"
      contains: "validate_config"
      min_lines: 300
  key_links:
    - from: "service_configure"
      to: "validate_config"
      via: "function call before config generation"
      pattern: "validate_config"
    - from: "validate_config"
      to: "ONEAPP_COPILOT_CONTEXT_SIZE"
      via: "numeric range validation"
      pattern: "ONEAPP_COPILOT_CONTEXT_SIZE"
    - from: "validate_config"
      to: "ONEAPP_COPILOT_THREADS"
      via: "non-negative integer validation"
      pattern: "ONEAPP_COPILOT_THREADS"
---

<objective>
Add context variable validation to service_configure, implement a smoke test helper function, and polish the complete appliance.sh to production quality with shellcheck compliance.

Purpose: This final plan for Phase 1 ensures all 9 INFER requirements are fully addressed, context variables are validated, and the script is production-ready. After this, the appliance script is complete for Phase 1 and ready for Phase 2 (Nginx) to build upon.
Output: Production-quality appliance.sh with validation, smoke tests, and shellcheck compliance covering all INFER-01 through INFER-09 requirements.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-inference-engine/01-RESEARCH.md
@.planning/phases/01-inference-engine/01-01-SUMMARY.md
@.planning/phases/01-inference-engine/01-02-SUMMARY.md
@appliances/slm-copilot/appliance.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add context variable validation and smoke test helper</name>
  <files>appliances/slm-copilot/appliance.sh</files>
  <action>
Add two new helper functions and wire validation into service_configure.

**1. Add validate_config() function** (in the HELPER section):

This function validates ONEAPP_COPILOT_* context variables. Called at the beginning of service_configure(), BEFORE any config file generation. Pattern matches the SuperLink's validate_config.

```bash
validate_config() {
    local _errors=0

    # ONEAPP_COPILOT_CONTEXT_SIZE: must be a positive integer, reasonable range 512-131072
    if ! [[ "${ONEAPP_COPILOT_CONTEXT_SIZE}" =~ ^[1-9][0-9]*$ ]]; then
        msg error "ONEAPP_COPILOT_CONTEXT_SIZE='${ONEAPP_COPILOT_CONTEXT_SIZE}' -- must be a positive integer"
        _errors=$((_errors + 1))
    elif [ "${ONEAPP_COPILOT_CONTEXT_SIZE}" -lt 512 ]; then
        msg error "ONEAPP_COPILOT_CONTEXT_SIZE='${ONEAPP_COPILOT_CONTEXT_SIZE}' -- minimum 512 tokens"
        _errors=$((_errors + 1))
    elif [ "${ONEAPP_COPILOT_CONTEXT_SIZE}" -gt 131072 ]; then
        msg warning "ONEAPP_COPILOT_CONTEXT_SIZE='${ONEAPP_COPILOT_CONTEXT_SIZE}' -- very large context, may cause OOM on 32 GB VM"
    fi

    # ONEAPP_COPILOT_THREADS: must be a non-negative integer (0 = auto-detect)
    if ! [[ "${ONEAPP_COPILOT_THREADS}" =~ ^[0-9]+$ ]]; then
        msg error "ONEAPP_COPILOT_THREADS='${ONEAPP_COPILOT_THREADS}' -- must be a non-negative integer (0=auto)"
        _errors=$((_errors + 1))
    fi

    # Abort on validation errors
    if [ "${_errors}" -gt 0 ]; then
        msg error "Configuration validation failed with ${_errors} error(s) -- aborting"
        exit 1
    fi

    msg info "Configuration validation passed (context_size=${ONEAPP_COPILOT_CONTEXT_SIZE}, threads=${ONEAPP_COPILOT_THREADS})"
}
```

**2. Wire validate_config into service_configure():**

Add `validate_config` as the FIRST call in service_configure(), before the AVX2 check and before any generate_* calls. The function should be called right after the `msg info "Configuring SLM-Copilot"` line.

**3. Add smoke_test() helper function:**

This function is used by service_install during pre-warming (can be called instead of inline curl), and will be useful for the Phase 4 test script. Add it in the HELPER section:

```bash
smoke_test() {
    local _endpoint="${1:-http://127.0.0.1:8080}"
    local _failed=0

    msg info "Running smoke test against ${_endpoint}"

    # Test 1: Non-streaming chat completion (INFER-01)
    local _response
    _response=$(curl -sf "${_endpoint}/v1/chat/completions" \
        -H 'Content-Type: application/json' \
        -d "{\"model\":\"${LOCALAI_MODEL_NAME}\",\"messages\":[{\"role\":\"user\",\"content\":\"Write a Python hello world\"}],\"max_tokens\":50}") || {
        msg error "Smoke test: chat completion request failed"
        return 1
    }
    echo "${_response}" | jq -e '.choices[0].message.content' >/dev/null 2>&1 || {
        msg error "Smoke test: no content in chat completion response"
        return 1
    }
    msg info "Smoke test: chat completion OK"

    # Test 2: Streaming chat completion (INFER-02)
    curl -sf "${_endpoint}/v1/chat/completions" \
        -H 'Content-Type: application/json' \
        -d "{\"model\":\"${LOCALAI_MODEL_NAME}\",\"messages\":[{\"role\":\"user\",\"content\":\"Say hello\"}],\"max_tokens\":10,\"stream\":true}" \
        | grep -q 'data:' || {
        msg error "Smoke test: streaming response has no SSE data lines"
        return 1
    }
    msg info "Smoke test: streaming OK"

    # Test 3: Health endpoint (INFER-05)
    curl -sf "${_endpoint}/readyz" >/dev/null 2>&1 || {
        msg error "Smoke test: /readyz did not return 200"
        return 1
    }
    msg info "Smoke test: health check OK"

    msg info "All smoke tests passed"
    return 0
}
```

**4. Update service_install pre-warm section** to use the smoke_test helper instead of inline curl commands. Replace the inline test with:
```bash
smoke_test "http://127.0.0.1:8080" || {
    kill "${_prewarm_pid}" 2>/dev/null || true
    wait "${_prewarm_pid}" 2>/dev/null || true
    exit 1
}
```

**5. Update service_help()** to include a complete reference. Update the heredoc to show:
- Service name and description
- All ONEAPP_COPILOT_* variables with descriptions and defaults
- Port information (8080 on localhost only)
- Service management commands (systemctl status/restart/stop local-ai, journalctl -u local-ai -f)
- Configuration file locations (/opt/local-ai/models/devstral-small-2.yaml, /opt/local-ai/config/local-ai.env, /etc/systemd/system/local-ai.service)
- Health check: `curl http://127.0.0.1:8080/readyz`
- Test command: `curl http://127.0.0.1:8080/v1/chat/completions -H 'Content-Type: application/json' -d '{"model":"devstral-small-2","messages":[{"role":"user","content":"Hello"}]}'`
  </action>
  <verify>
Run `bash -n appliances/slm-copilot/appliance.sh` to verify syntax.
Run `grep -c 'validate_config' appliances/slm-copilot/appliance.sh` -- must be >= 2 (definition + call in service_configure).
Run `grep -c 'smoke_test' appliances/slm-copilot/appliance.sh` -- must be >= 2 (definition + call in service_install pre-warm).
Run `grep 'ONEAPP_COPILOT_CONTEXT_SIZE' appliances/slm-copilot/appliance.sh | head -10` -- must show validation checks.
Run `grep 'ONEAPP_COPILOT_THREADS' appliances/slm-copilot/appliance.sh | head -10` -- must show validation checks.
  </verify>
  <done>validate_config() validates ONEAPP_COPILOT_CONTEXT_SIZE (positive int, 512-131072 range) and ONEAPP_COPILOT_THREADS (non-negative int). smoke_test() verifies chat completion, streaming, and health endpoint. Validation is wired into service_configure as the first call. Pre-warm section in service_install uses smoke_test helper. service_help shows complete reference.</done>
</task>

<task type="auto">
  <name>Task 2: Shellcheck compliance and final polish</name>
  <files>appliances/slm-copilot/appliance.sh</files>
  <action>
Run shellcheck on the appliance.sh and fix all warnings/errors. Then do a final review pass.

**Step 1: Run shellcheck**
```bash
shellcheck -s bash appliances/slm-copilot/appliance.sh
```

Common issues to fix proactively:
- SC2034: Variables appear unused -- add `# shellcheck disable=SC2034` for ONE_SERVICE_* vars (they're read by the one-apps framework, not this script)
- SC2086: Double-quote variable expansions in curl commands and paths
- SC2155: Declare and assign separately for `local` variables that capture command output
- SC2016: Use `$'...'` or escape `$` in heredocs where literal `$` is intended

**Step 2: Add shellcheck directives at the top of the file** (after the shebang):
```bash
# shellcheck disable=SC2034  # ONE_SERVICE_* vars used by one-apps framework
```

Only disable SC2034 globally -- fix all other warnings in-place.

**Step 3: Verify the complete file structure** follows this order:
1. Shebang + header comment
2. Shellcheck directives
3. ONE_SERVICE_* metadata
4. ONE_SERVICE_PARAMS array
5. Default value assignments
6. Constants
7. service_install()
8. service_configure()
9. service_bootstrap()
10. service_help()
11. service_cleanup()
12. Helper functions (validate_config, generate_model_yaml, generate_env_file, generate_systemd_unit, wait_for_localai, smoke_test)

**Step 4: Final requirement checklist verification.**
Ensure the script addresses ALL Phase 1 requirements:
- INFER-01: Model served via /v1/chat/completions (model YAML + LocalAI startup) -- CHECK
- INFER-02: Streaming SSE works (smoke_test checks streaming) -- CHECK
- INFER-03: Model baked into image (service_install downloads GGUF) -- CHECK
- INFER-04: systemd auto-restart (Restart=on-failure in unit) -- CHECK
- INFER-05: /readyz health check (wait_for_localai checks it, smoke_test verifies) -- CHECK
- INFER-06: Context size configurable (ONEAPP_COPILOT_CONTEXT_SIZE -> model YAML + env) -- CHECK
- INFER-07: Threads configurable (ONEAPP_COPILOT_THREADS -> model YAML + env) -- CHECK
- INFER-08: Loopback only (--address 127.0.0.1:8080 in systemd unit) -- CHECK
- INFER-09: Backend pre-downloaded (local-ai backends install llama-cpp in service_install) -- CHECK

If any requirement is not addressed, add the missing implementation.

**Step 5: Verify no accidental append patterns.**
Search for `>>` in the file. There should be NONE (all config generation uses `>` for idempotency). The only acceptable `>>` would be in log-related code, but we don't do custom logging (one-apps `msg` handles it).
  </action>
  <verify>
Run `shellcheck -s bash appliances/slm-copilot/appliance.sh` -- must exit 0 with no warnings (or only disabled ones).
Run `bash -n appliances/slm-copilot/appliance.sh` -- must exit 0.
Run `wc -l appliances/slm-copilot/appliance.sh` -- should be 300+ lines for a complete script.
Run `grep -c '>>' appliances/slm-copilot/appliance.sh` -- should be 0 (no append patterns).
Run `grep -c 'INFER-0[1-9]' appliances/slm-copilot/appliance.sh` -- optional, but comments referencing requirements are welcome.
Verify all 5 lifecycle functions + 6 helpers present:
`grep -cE '^(service_|validate_|generate_|wait_for_|smoke_)' appliances/slm-copilot/appliance.sh` -- should be 11.
  </verify>
  <done>appliance.sh passes shellcheck and bash -n with zero warnings. All 9 INFER requirements are addressed. File structure follows one-apps conventions. No append patterns. All functions properly defined and called. Script is ready for Phase 2 extensions (Nginx, TLS, auth).</done>
</task>

</tasks>

<verification>
- `shellcheck -s bash appliances/slm-copilot/appliance.sh` exits 0
- `bash -n appliances/slm-copilot/appliance.sh` exits 0
- validate_config() validates CONTEXT_SIZE (positive int, range 512-131072) and THREADS (non-negative int)
- validate_config is called at the start of service_configure
- smoke_test() verifies chat completion, streaming, and health endpoint
- smoke_test is used in service_install pre-warm
- service_help provides complete reference documentation
- No `>>` append patterns anywhere in the file
- All 9 INFER requirements addressed (mapped to specific code locations)
</verification>

<success_criteria>
The appliance.sh is production-quality: shellcheck-clean, complete validation, reusable smoke test helper, comprehensive service_help, and every INFER requirement addressed with specific code. Ready for Phase 2 to extend with Nginx reverse proxy, TLS, and authentication.
</success_criteria>

<output>
After completion, create `.planning/phases/01-inference-engine/01-03-SUMMARY.md`
</output>
