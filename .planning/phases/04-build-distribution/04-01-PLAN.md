---
phase: 04-build-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - build/packer/slm-copilot.pkr.hcl
  - build/packer/variables.pkr.hcl
  - build/packer/cloud-init.yml
  - build/packer/scripts/80-install-context.sh
  - build/packer/scripts/81-configure-ssh.sh
  - build/packer/scripts/82-configure-context.sh
  - build.sh
  - Makefile
autonomous: true

must_haves:
  truths:
    - "Running `make build` invokes build.sh which checks dependencies, downloads the Ubuntu 24.04 cloud image, runs Packer, compresses the QCOW2, and generates checksums"
    - "The Packer HCL definition produces a QCOW2 image via the two-build pattern (cloud-init seed ISO + QEMU provisioning) with 4 vCPU, 16 GB RAM, 50 GB disk"
    - "The 8-step provisioning sequence installs SSH hardening, one-context, one-apps framework, appliance script, context hooks, runs service_install, and cleans up"
    - "Makefile provides build, checksum, clean, and lint targets with configurable variables"
  artifacts:
    - path: "build/packer/slm-copilot.pkr.hcl"
      provides: "Two-build Packer definition: null source for cloud-init ISO + QEMU source for QCOW2 provisioning"
      contains: "source \"qemu\" \"slm_copilot\""
    - path: "build/packer/variables.pkr.hcl"
      provides: "Packer variables for appliance_name, input_dir, output_dir, headless, version, one_apps_dir"
      contains: "variable \"appliance_name\""
    - path: "build/packer/cloud-init.yml"
      provides: "Cloud-init YAML enabling root SSH with password for Packer provisioning"
      contains: "#cloud-config"
    - path: "build/packer/scripts/80-install-context.sh"
      provides: "Installs one-context .deb package from /context/ staging directory"
      contains: "dpkg -i"
    - path: "build/packer/scripts/81-configure-ssh.sh"
      provides: "SSH hardening: disables password auth, enables key-only after Packer provisioning"
      contains: "PermitRootLogin"
    - path: "build/packer/scripts/82-configure-context.sh"
      provides: "Moves one-apps context hook scripts into /etc/one-context.d/"
      contains: "one-context"
    - path: "build.sh"
      provides: "Build wrapper: dependency checks, base image download, one-apps clone, packer init+build, QCOW2 compression, checksums"
      contains: "packer build"
    - path: "Makefile"
      provides: "Build orchestration with build, checksum, clean, lint targets"
      contains: ".PHONY"
  key_links:
    - from: "Makefile build target"
      to: "build.sh"
      via: "make build calls ./build.sh"
      pattern: "\\./build\\.sh"
    - from: "build.sh"
      to: "build/packer/slm-copilot.pkr.hcl"
      via: "packer build build/packer/"
      pattern: "packer build"
    - from: "slm-copilot.pkr.hcl Step 5"
      to: "appliances/slm-copilot/appliance.sh"
      via: "file provisioner copies appliance.sh into VM"
      pattern: "appliance\\.sh"
    - from: "slm-copilot.pkr.hcl Step 7"
      to: "/etc/one-appliance/service install"
      via: "shell provisioner runs service_install inside Packer VM"
      pattern: "service install"
---

<objective>
Create the Packer HCL2 build definition, cloud-init configuration, provisioner scripts, build wrapper script, and Makefile for building the SLM-Copilot QCOW2 image.

Purpose: Requirements BUILD-01 (Packer HCL), BUILD-05 (Makefile), and BUILD-06 (build wrapper) deliver the entire build pipeline. A developer runs `make build` and gets a compressed, checksummed QCOW2 image ready for deployment or marketplace submission.

Output: Complete build pipeline -- Packer HCL with two-build pattern, cloud-init.yml, three provisioner scripts (80/81/82), build.sh wrapper, and Makefile with build/checksum/clean/lint targets.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-build-distribution/04-RESEARCH.md
@appliances/slm-copilot/appliance.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Packer HCL definition, variables, cloud-init, and provisioner scripts</name>
  <files>
    build/packer/slm-copilot.pkr.hcl
    build/packer/variables.pkr.hcl
    build/packer/cloud-init.yml
    build/packer/scripts/80-install-context.sh
    build/packer/scripts/81-configure-ssh.sh
    build/packer/scripts/82-configure-context.sh
  </files>
  <action>
Create the complete Packer build definition following the two-build pattern from the Flower SuperLink appliance (see 04-RESEARCH.md Pattern 1 and Code Examples section).

**A. Create `build/packer/variables.pkr.hcl`** with these variables:
- `appliance_name` (string, default "slm-copilot")
- `input_dir` (string, description "Directory containing base OS image")
- `output_dir` (string, description "Directory for output QCOW2 image")
- `headless` (bool, default true)
- `version` (string, default "1.0.0")
- `one_apps_dir` (string, description "Path to one-apps repository checkout")

**B. Create `build/packer/slm-copilot.pkr.hcl`** with:

1. `packer` block requiring `qemu` plugin >= 1.1.0
2. Build 1 (context): `null` source with `shell-local` provisioner running `cloud-localds ${var.appliance_name}-cloud-init.iso cloud-init.yml`
3. Build 2 (slm-copilot): `qemu` source with:
   - `accelerator = "kvm"`, `cpus = 4`, `memory = 16384`, `disk_size = "50G"`
   - `iso_url = "${var.input_dir}/ubuntu2404.qcow2"`, `iso_checksum = "none"`, `disk_image = true`
   - `output_directory = "${var.output_dir}"`, `vm_name = "${var.appliance_name}.qcow2"`, `format = "qcow2"`
   - `headless = var.headless`
   - `net_device = "virtio-net"`, `disk_interface = "virtio"`
   - `qemuargs` with `-cdrom` (cloud-init ISO), `-serial mon:stdio`, `-cpu host`
   - `boot_wait = "30s"`
   - SSH: `ssh_username = "root"`, `ssh_password = "opennebula"`, `ssh_timeout = "30m"`
   - `shutdown_command = "poweroff"`

4. Build 2 provisioners (8-step sequence from 04-RESEARCH.md Pattern 2):
   - Step 1: SSH hardening via `scripts/81-configure-ssh.sh`
   - Step 2: Create /context dir, file provisioner copies `${var.one_apps_dir}/context-linux/out/` to `/context`, run `scripts/80-install-context.sh`
   - Step 3: Shell inline creates one-appliance directory structure (`/etc/one-appliance/{,service.d/,lib/}` and `/opt/one-appliance/{,bin/}`)
   - Step 4: File provisioners copy framework files from `${var.one_apps_dir}/appliances/`: `scripts/net-90-service-appliance` and `scripts/net-99-report-ready` to `/etc/one-appliance/`, `service.sh` to `/etc/one-appliance/service` (then chmod 0755), `lib/common.sh` and `lib/functions.sh` to `/etc/one-appliance/lib/`
   - Step 5: File provisioner copies `../../appliances/slm-copilot/appliance.sh` to `/etc/one-appliance/service.d/appliance.sh`
   - Step 6: Run `scripts/82-configure-context.sh` to move context hooks
   - Step 7: Shell inline runs `/etc/one-appliance/service install && sync` (this downloads LocalAI, model, pre-warms)
   - Step 8: Cleanup shell inline: purge cloud-init/snapd/fwupd, autoremove, apt-get clean, remove /var/lib/apt/lists, remove cloudimg-ipv6 sysctl, remove /context/, truncate machine-id, remove /var/lib/dbus/machine-id, clear /tmp and /var/tmp, sync

Use the exact code example from 04-RESEARCH.md (lines 358-515) as the authoritative template.

**C. Create `build/packer/cloud-init.yml`** -- exact copy of the template from 04-RESEARCH.md (lines 555-587). Includes `growpart` for auto-expand, root user with hashed password "opennebula", `disable_root: false`, `ssh_pwauth: true`, and `runcmd` block to enable PermitRootLogin and PasswordAuthentication for Packer SSH access.

**D. Create `build/packer/scripts/81-configure-ssh.sh`** -- SSH hardening script. Source from the Flower appliance at `/home/pablo/flower-opennebula/build/packer/scripts/81-configure-ssh.sh`. This script disables password authentication and reverts PermitRootLogin after Packer provisioning is complete.

**E. Create `build/packer/scripts/80-install-context.sh`** -- one-context installer. Source from the Flower appliance at `/home/pablo/flower-opennebula/build/packer/scripts/80-install-context.sh`. This installs the one-context .deb package from the staged /context/ directory.

**F. Create `build/packer/scripts/82-configure-context.sh`** -- context hook setup. Source from the Flower appliance at `/home/pablo/flower-opennebula/build/packer/scripts/82-configure-context.sh`. This moves the net-90 and net-99 scripts into the correct one-context.d location.

All three provisioner scripts must:
- Start with `#!/usr/bin/env bash` and `set -euo pipefail`
- Pass `shellcheck` with zero warnings
- Be executable (chmod +x)
  </action>
  <verify>
- All 6 files exist in their expected paths
- `shellcheck build/packer/scripts/*.sh` passes with zero warnings
- `grep 'source.*qemu' build/packer/slm-copilot.pkr.hcl` shows the QEMU source
- `grep 'disk_size.*50G' build/packer/slm-copilot.pkr.hcl` shows correct disk size
- `grep 'ssh_timeout.*30m' build/packer/slm-copilot.pkr.hcl` shows extended timeout
- `grep 'cloud-localds' build/packer/slm-copilot.pkr.hcl` shows seed ISO generation
- `grep 'service install' build/packer/slm-copilot.pkr.hcl` shows step 7
- `grep 'cloud-config' build/packer/cloud-init.yml` confirms cloud-init format
  </verify>
  <done>
Complete Packer build definition with two-build pattern (cloud-init ISO + QEMU provisioner), 8-step provisioning sequence matching one-apps conventions, cloud-init.yml for SSH access, and three provisioner scripts (80/81/82) all passing shellcheck. Packer VM sized for model download: 4 vCPU, 16 GB RAM, 50 GB disk, 30m SSH timeout.

Requirements addressed: BUILD-01 (Packer HCL2 builds compressed QCOW2 from Ubuntu 24.04).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create build wrapper script and Makefile</name>
  <files>
    build.sh
    Makefile
  </files>
  <action>
**A. Create `build.sh`** at the project root. Follow 04-RESEARCH.md Pattern 4 (Build Wrapper Script).

The script must:
1. Start with `#!/usr/bin/env bash` and `set -euo pipefail`
2. Define variables at the top:
   - `SCRIPT_DIR` (via `cd "$(dirname "$0")" && pwd`)
   - `INPUT_DIR="${INPUT_DIR:-${SCRIPT_DIR}/build/images}"`
   - `OUTPUT_DIR="${OUTPUT_DIR:-${SCRIPT_DIR}/build/export}"`
   - `ONE_APPS_DIR="${ONE_APPS_DIR:-${SCRIPT_DIR}/build/one-apps}"`
   - `PACKER_DIR="${SCRIPT_DIR}/build/packer"`
   - `HEADLESS="${HEADLESS:-true}"`
   - `VERSION="${VERSION:-1.0.0}"`
   - `APPLIANCE_NAME="slm-copilot"`
   - `IMAGE_NAME="${APPLIANCE_NAME}-${VERSION}.qcow2"`
   - Ubuntu cloud image URL: `https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img`
   - one-apps git URL: `https://github.com/OpenNebula/one-apps.git`

3. `check_dependencies()` function -- verify presence of: `packer`, `qemu-img`, `cloud-localds`, `qemu-system-x86_64`. For KVM, check that `/dev/kvm` exists and is accessible. Print clear error messages for each missing dependency and exit 1 if any missing.

4. `download_base_image()` function -- if `${INPUT_DIR}/ubuntu2404.qcow2` does not exist, create `${INPUT_DIR}`, download the Ubuntu cloud image with `curl -fSL -o`, and rename/symlink to `ubuntu2404.qcow2`. Skip download if file already exists (print "Base image found, skipping download").

5. `setup_one_apps()` function -- if `${ONE_APPS_DIR}` does not exist, clone one-apps from GitHub. If it exists, print "one-apps found at ${ONE_APPS_DIR}". Check that `${ONE_APPS_DIR}/appliances/service.sh` exists; if not, error with instructions.

6. `run_packer()` function -- cd to `${PACKER_DIR}`, run `packer init .`, then run `packer build` passing variables via `-var`:
   - `input_dir=${INPUT_DIR}`
   - `output_dir=${OUTPUT_DIR}`
   - `headless=${HEADLESS}`
   - `version=${VERSION}`
   - `one_apps_dir=${ONE_APPS_DIR}`

7. `compress_image()` function -- run `qemu-img convert -c -O qcow2 "${OUTPUT_DIR}/${APPLIANCE_NAME}.qcow2" "${OUTPUT_DIR}/${IMAGE_NAME}"`. Then remove the uncompressed original. Print the compressed image size via `du -h`.

8. `generate_checksums()` function -- cd to `${OUTPUT_DIR}`, run `sha256sum` and `md5sum` on `${IMAGE_NAME}`, write results to `${IMAGE_NAME}.sha256` and `${IMAGE_NAME}.md5`. Print both checksums.

9. `main()` function that calls all steps in order, with `echo "==>"` progress messages between steps.

10. `main "$@"` at the bottom.

Ensure the script passes shellcheck with zero warnings. Use `"${var}"` quoting everywhere.

**B. Create `Makefile`** at the project root. Follow 04-RESEARCH.md Pattern 6 (Makefile).

```makefile
SHELL := /bin/bash

# Directories
INPUT_DIR   ?= $(CURDIR)/build/images
OUTPUT_DIR  ?= $(CURDIR)/build/export
ONE_APPS_DIR ?= $(CURDIR)/build/one-apps
PACKER_DIR  := $(CURDIR)/build/packer

# Build settings
HEADLESS    ?= true
VERSION     ?= 1.0.0
IMAGE_NAME  := slm-copilot-$(VERSION).qcow2

# Test settings (required for 'make test')
ENDPOINT    ?=
PASSWORD    ?=

.PHONY: build test checksum clean lint help

help:
	@echo "SLM-Copilot Build Targets"
	@echo "========================="
	@echo "  make build                              Build QCOW2 image"
	@echo "  make test ENDPOINT=... PASSWORD=...     Test running instance"
	@echo "  make checksum                           Generate checksums for image"
	@echo "  make clean                              Remove build artifacts"
	@echo "  make lint                               Shellcheck all bash scripts"

build:
	@echo "==> Building SLM-Copilot image..."
	INPUT_DIR=$(INPUT_DIR) OUTPUT_DIR=$(OUTPUT_DIR) ONE_APPS_DIR=$(ONE_APPS_DIR) \
	HEADLESS=$(HEADLESS) VERSION=$(VERSION) \
	./build.sh

test:
	@test -n "$(ENDPOINT)" || { echo "ERROR: ENDPOINT required (e.g., make test ENDPOINT=https://10.0.0.1 PASSWORD=xxx)"; exit 1; }
	@test -n "$(PASSWORD)" || { echo "ERROR: PASSWORD required"; exit 1; }
	./test.sh "$(ENDPOINT)" "$(PASSWORD)"

checksum: $(OUTPUT_DIR)/$(IMAGE_NAME)
	@echo "==> Generating checksums..."
	cd $(OUTPUT_DIR) && sha256sum $(IMAGE_NAME) > $(IMAGE_NAME).sha256
	cd $(OUTPUT_DIR) && md5sum $(IMAGE_NAME) > $(IMAGE_NAME).md5
	@echo "SHA256: $$(cat $(OUTPUT_DIR)/$(IMAGE_NAME).sha256)"
	@echo "MD5:    $$(cat $(OUTPUT_DIR)/$(IMAGE_NAME).md5)"

clean:
	rm -rf $(OUTPUT_DIR)
	rm -f $(PACKER_DIR)/slm-copilot-cloud-init.iso
	@echo "==> Build artifacts cleaned."

lint:
	@echo "==> Running shellcheck on all bash scripts..."
	@shellcheck -x appliances/slm-copilot/appliance.sh
	@if [ -f build.sh ]; then shellcheck -x build.sh; fi
	@if [ -f test.sh ]; then shellcheck -x test.sh; fi
	@find build/packer/scripts -name '*.sh' -exec shellcheck -x {} + 2>/dev/null || true
	@echo "==> All scripts passed shellcheck."
```

The Makefile `build` target passes env vars to build.sh. The `test` target validates ENDPOINT and PASSWORD are set. The `lint` target runs shellcheck on all bash scripts in the repo (appliance.sh, build.sh, test.sh, packer scripts).

Ensure the Makefile uses tabs (not spaces) for recipe lines.
  </action>
  <verify>
- `build.sh` exists at project root and is executable
- `Makefile` exists at project root
- `shellcheck build.sh` passes with zero warnings
- `bash -n build.sh` passes
- `grep 'packer build' build.sh` shows Packer invocation
- `grep 'qemu-img convert' build.sh` shows compression step
- `grep 'sha256sum' build.sh` shows checksum generation
- `grep '.PHONY' Makefile` shows all targets declared
- `make help` runs without error (prints usage)
- `make lint` runs shellcheck on appliance.sh, build.sh, and packer scripts
  </verify>
  <done>
build.sh wrapper handles the full build lifecycle: dependency checking (packer, qemu-img, cloud-localds, /dev/kvm), base image download, one-apps clone, packer init+build, QCOW2 compression, and checksum generation. Makefile provides build, test, checksum, clean, lint, and help targets with configurable variables (INPUT_DIR, OUTPUT_DIR, ONE_APPS_DIR, HEADLESS, VERSION, ENDPOINT, PASSWORD).

Requirements addressed: BUILD-05 (Makefile targets), BUILD-06 (build wrapper script).
  </done>
</task>

</tasks>

<verification>
Phase 4 Plan 01 verification:
1. `ls build/packer/slm-copilot.pkr.hcl build/packer/variables.pkr.hcl build/packer/cloud-init.yml` -- all Packer files exist
2. `ls build/packer/scripts/80-install-context.sh build/packer/scripts/81-configure-ssh.sh build/packer/scripts/82-configure-context.sh` -- all provisioner scripts exist
3. `ls build.sh Makefile` -- build wrapper and Makefile exist
4. `shellcheck build/packer/scripts/*.sh build.sh` -- all scripts pass shellcheck
5. `grep 'disk_size.*50G' build/packer/slm-copilot.pkr.hcl` -- correct VM sizing
6. `grep 'service install' build/packer/slm-copilot.pkr.hcl` -- step 7 present
7. `make help` -- prints target list without error
</verification>

<success_criteria>
- Packer HCL definition uses two-build pattern with QEMU builder (4 vCPU, 16 GB RAM, 50 GB disk, 30m SSH timeout)
- 8-step provisioning sequence follows one-apps conventions exactly
- Cloud-init.yml enables root SSH access for Packer with growpart for disk expansion
- Three provisioner scripts (80/81/82) follow Flower appliance pattern
- build.sh handles complete build lifecycle with dependency checking and error handling
- Makefile provides build, test, checksum, clean, lint targets
- All new bash scripts pass shellcheck with zero warnings
- BUILD-01, BUILD-05, BUILD-06 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-build-distribution/04-01-SUMMARY.md`
</output>
